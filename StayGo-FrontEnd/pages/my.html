<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard • StayGo</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body{background:#0b1220;color:#dbe5ff}
    .card{background:#121a2a;border:1px solid #1d2740}
    .card .text-muted{color:#8fa3c9!important}
    .badge-soft{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.08)}
    .status-active{background:rgba(25,135,84,.15);color:#69d2a3;border:1px solid rgba(25,135,84,.2)}
    .status-inactive{background:rgba(220,53,69,.15);color:#ff9eaa;border:1px solid rgba(220,53,69,.2)}
    .nav-pills .nav-link{color:#b8c6e6}
    .nav-pills .nav-link.active{background:#304bff}
    .searchbar{background:#0f1730;border:1px solid #1d2740}
    .table{--bs-table-bg:transparent;--bs-table-color:#dbe5ff}
    .table>thead>tr>th{color:#8fa3c9;border-bottom-color:#223055}
    .table>tbody>tr>td{border-color:#16203a}
    .btn-outline-light{--bs-btn-hover-bg:#304bff;--bs-btn-hover-border-color:#304bff}
    .spinner{display:none}
  </style>
</head>
<body>
  <nav class="navbar navbar-dark" style="background:#0f1730;border-bottom:1px solid #1d2740">
    <div class="container-fluid">
      <span class="navbar-brand fw-semibold"><i class="bi bi-speedometer2 me-2"></i>StayGo • Admin Dashboard</span>
      <div class="d-flex gap-2">
        <button id="refreshBtn" class="btn btn-outline-light btn-sm"><i class="bi bi-arrow-clockwise me-1"></i>Refresh</button>
      </div>
    </div>
  </nav>

  <main class="container-fluid py-4">
    <!-- Top KPI cards -->
    <div class="row g-3" id="kpiRow">
      <div class="col-6 col-md-4 col-xl-2">
        <div class="card rounded-4 p-3 h-100">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-muted small">Total Users</div>
              <div class="fs-4 fw-bold" id="kpiTotalUsers">—</div>
            </div>
            <i class="bi bi-people fs-3 text-primary"></i>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-4 col-xl-2">
        <div class="card rounded-4 p-3 h-100">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-muted small">Admins</div>
              <div class="fs-4 fw-bold" id="kpiAdmins">—</div>
            </div>
            <i class="bi bi-shield-lock fs-3 text-info"></i>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-4 col-xl-2">
        <div class="card rounded-4 p-3 h-100">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-muted small">Business</div>
              <div class="fs-4 fw-bold" id="kpiBusiness">—</div>
            </div>
            <i class="bi bi-buildings fs-3 text-warning"></i>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-4 col-xl-2">
        <div class="card rounded-4 p-3 h-100">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-muted small">Partners</div>
              <div class="fs-4 fw-bold" id="kpiPartners">—</div>
            </div>
            <i class="bi bi-handshake fs-3 text-success"></i>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-4 col-xl-2">
        <div class="card rounded-4 p-3 h-100">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-muted small">Clients</div>
              <div class="fs-4 fw-bold" id="kpiClients">—</div>
            </div>
            <i class="bi bi-person-badge fs-3 text-danger"></i>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-4 col-xl-2">
        <div class="card rounded-4 p-3 h-100">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-muted small">Active / Inactive</div>
              <div class="fs-6"><span class="fw-bold" id="kpiActive">—</span> / <span id="kpiInactive">—</span></div>
            </div>
            <i class="bi bi-activity fs-3 text-success"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="row g-3 mt-1 align-items-center">
      <div class="col-12 col-lg-8">
        <ul class="nav nav-pills gap-2" id="filterTabs">
          <li class="nav-item"><button class="nav-link active" data-filter="ALL">All</button></li>
          <li class="nav-item"><button class="nav-link" data-filter="BUSINESS">Business</button></li>
          <li class="nav-item"><button class="nav-link" data-filter="PARTNER">Partner</button></li>
          <li class="nav-item"><button class="nav-link" data-filter="CLIENT">Client</button></li>
          <li class="nav-item"><button class="nav-link" data-filter="ACTIVE">Active</button></li>
          <li class="nav-item"><button class="nav-link" data-filter="INACTIVE">Inactive</button></li>
        </ul>
      </div>
      <div class="col-12 col-lg-4">
        <div class="input-group searchbar rounded-4">
          <span class="input-group-text bg-transparent border-0 text-secondary"><i class="bi bi-search"></i></span>
          <input id="searchInput" class="form-control bg-transparent border-0 text-light" placeholder="Search by name, username, email, phone or ID…" />
          <button id="clearSearch" class="btn btn-outline-light">Clear</button>
        </div>
      </div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-12 col-xxl-8">
        <div class="card rounded-4">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="card-title m-0">Users</h5>
              <div class="d-flex align-items-center gap-2">
                <span class="spinner-border spinner-border-sm" id="tableSpinner"></span>
                <div class="form-text text-muted" id="tableInfo"></div>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table align-middle" id="usersTable">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Role</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div class="text-muted small" id="paginationLabel">Page —</div>
              <nav>
                <ul class="pagination pagination-sm m-0" id="pagination"></ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-xxl-4">
        <div class="card rounded-4 mb-3">
          <div class="card-body">
            <h6 class="mb-3">Users by Role</h6>
            <canvas id="roleChart" height="220"></canvas>
          </div>
        </div>
        <div class="card rounded-4">
          <div class="card-body">
            <h6 class="mb-3">Active vs Inactive</h6>
            <canvas id="statusChart" height="220"></canvas>
          </div>
        </div>
      </div>
    </div>
  </main>

  <template id="rowTemplate">
    <tr>
      <td data-col="id"></td>
      <td data-col="fullName"></td>
      <td data-col="username"></td>
      <td data-col="email"></td>
      <td data-col="phoneNumber"></td>
      <td data-col="role"></td>
      <td data-col="status"></td>
    </tr>
  </template>

  <script>
    // ======= CONFIG =======
    const API_BASE = 'http://localhost:8080/api/v1/AdminDashboardUsersManage';
    const PAGE_SIZE = 10;

    // ======= STATE =======
    let currentPage = 0;
    let totalPages = 0;
    let currentFilter = 'ALL'; // ALL, BUSINESS, PARTNER, CLIENT, ACTIVE, INACTIVE
    let searching = false;
    let charts = { role: null, status: null };

    // ======= HELPERS =======
    const $ = (s, p=document) => p.querySelector(s);
    const $$ = (s, p=document) => Array.from(p.querySelectorAll(s));

    const showSpinner = (el, show=true) => { el.style.display = show ? 'inline-block' : 'none'; };

    async function apiGet(path) {
      const res = await fetch(`${API_BASE}${path}`);
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return await res.json(); // expects {code,message,data}
    }

    function setKPIs({ total, admins, business, partners, clients, active, inactive }) {
      $('#kpiTotalUsers').textContent = total ?? '—';
      $('#kpiAdmins').textContent = admins ?? '—';
      $('#kpiBusiness').textContent = business ?? '—';
      $('#kpiPartners').textContent = partners ?? '—';
      $('#kpiClients').textContent = clients ?? '—';
      $('#kpiActive').textContent = active ?? '—';
      $('#kpiInactive').textContent = inactive ?? '—';
    }

    function statusBadge(status) {
      const s = (status||'').toLowerCase();
      const cls = s === 'active' ? 'status-active' : 'status-inactive';
      const label = status || 'N/A';
      return `<span class="badge ${cls} rounded-pill px-2 py-1">${label}</span>`;
    }

    function renderTable(items) {
      const tbody = $('#usersTable tbody');
      tbody.innerHTML = '';
      const tpl = $('#rowTemplate');
      items.forEach(u => {
        const tr = tpl.content.cloneNode(true);
        tr.querySelector('[data-col="id"]').textContent = u.id ?? '-';
        tr.querySelector('[data-col="fullName"]').textContent = u.fullName ?? '-';
        tr.querySelector('[data-col="username"]').textContent = u.username ?? '-';
        tr.querySelector('[data-col="email"]').textContent = u.email ?? '-';
        tr.querySelector('[data-col="phoneNumber"]').textContent = u.phoneNumber ?? '-';
        tr.querySelector('[data-col="role"]').textContent = u.role ?? '-';
        tr.querySelector('[data-col="status"]').innerHTML = statusBadge(u.userStatus || u.status);
        tbody.appendChild(tr);
      });
    }

    function renderPagination(number, totalPages) {
      const ul = $('#pagination');
      ul.innerHTML = '';
      const create = (label, page, disabled=false, active=false) => {
        const li = document.createElement('li');
        li.className = `page-item ${disabled?'disabled':''} ${active?'active':''}`;
        const a = document.createElement('button');
        a.className = 'page-link';
        a.textContent = label;
        a.onclick = () => loadUsers(page);
        li.appendChild(a);
        return li;
      };
      ul.appendChild(create('«', 0, number===0));
      ul.appendChild(create('‹', Math.max(0, number-1), number===0));
      const start = Math.max(0, number-2);
      const end = Math.min(totalPages-1, number+2);
      for (let p=start; p<=end; p++) ul.appendChild(create(String(p+1), p, false, p===number));
      ul.appendChild(create('›', Math.min(totalPages-1, number+1), number>=totalPages-1));
      ul.appendChild(create('»', totalPages-1, number>=totalPages-1));
      $('#paginationLabel').textContent = `Page ${number+1} / ${totalPages}`;
    }

    function upsertChart(key, type, data, options) {
      const id = key==='role' ? 'roleChart' : 'statusChart';
      const ctx = document.getElementById(id);
      if (charts[key]) charts[key].destroy();
      charts[key] = new Chart(ctx, { type, data, options });
    }

    // ======= LOADERS =======
    async function loadKPIs() {
      const [total, admins, partners, business, clients, active, inactive] = await Promise.all([
        apiGet('/getUserCount'),
        apiGet('/getAdminCount'),
        apiGet('/getPartnerCount'),
        apiGet('/getBusinessCount'),
        apiGet('/getClientCount'),
        apiGet('/getActiveUserCount'),
        apiGet('/getInactiveUserCount'),
      ]);
      const data = {
        total: total.data, admins: admins.data, partners: partners.data,
        business: business.data, clients: clients.data, active: active.data, inactive: inactive.data
      };
      setKPIs(data);
      // Charts
      upsertChart('role', 'doughnut', {
        labels: ['Admins','Business','Partners','Clients'],
        datasets: [{ data: [data.admins, data.business, data.partners, data.clients] }]
      }, { plugins:{legend:{labels:{color:'#dbe5ff'}}}});
      upsertChart('status', 'doughnut', {
        labels: ['Active','Inactive'],
        datasets: [{ data: [data.active, data.inactive] }]
      }, { plugins:{legend:{labels:{color:'#dbe5ff'}}}});
    }

    function endpointForFilter(filter){
      switch(filter){
        case 'BUSINESS': return '/getAllBusinessUsers';
        case 'PARTNER': return '/getAllPartnerUsers';
        case 'CLIENT': return '/getAllClientUsers';
        case 'ACTIVE': return '/getAllActiveUsers';
        case 'INACTIVE': return '/getAllInactiveUsers';
        default: return '/getAllUsers';
      }
    }

    async function loadUsers(page = 0) {
      if (searching) return; // search mode shows its own results
      currentPage = page;
      const spinner = $('#tableSpinner');
      showSpinner(spinner, true);
      try{
        const ep = endpointForFilter(currentFilter);
        const res = await apiGet(`${ep}?page=${page}&size=${PAGE_SIZE}`);
        const pg = res.data; // Spring Page<UserDTO>
        renderTable(pg.content || []);
        totalPages = Math.max(1, pg.totalPages || 1);
        renderPagination(pg.number || 0, totalPages);
        $('#tableInfo').textContent = `${pg.totalElements ?? 0} users • showing ${pg.size ?? PAGE_SIZE} per page`;
      }catch(err){
        console.error(err);
        $('#tableInfo').textContent = 'Failed to load users';
      }finally{ showSpinner(spinner, false); }
    }

    async function performSearch(keyword){
      const spinner = $('#tableSpinner');
      showSpinner(spinner, true);
      try{
        const res = await apiGet(`/searchUsers?keyword=${encodeURIComponent(keyword || '')}`);
        const list = res.data || [];
        renderTable(list);
        $('#pagination').innerHTML = '';
        $('#paginationLabel').textContent = `Search results: ${list.length}`;
        $('#tableInfo').textContent = `Showing ${list.length} matched users`;
      }catch(err){
        console.error(err);
        $('#tableInfo').textContent = 'Search failed';
      }finally{ showSpinner(spinner, false); }
    }

    // ======= EVENTS =======
    $('#refreshBtn').addEventListener('click', () => { loadKPIs(); loadUsers(currentPage); });

    $$('#filterTabs .nav-link').forEach(btn => btn.addEventListener('click', (e)=>{
      $$('#filterTabs .nav-link').forEach(n=>n.classList.remove('active'));
      e.currentTarget.classList.add('active');
      currentFilter = e.currentTarget.dataset.filter;
      searching = false;
      $('#searchInput').value = '';
      loadUsers(0);
    }));

    let searchDebounce;
    $('#searchInput').addEventListener('input', (e)=>{
      const kw = e.target.value.trim();
      clearTimeout(searchDebounce);
      if (kw.length === 0){
        searching = false; loadUsers(0); return;
      }
      searchDebounce = setTimeout(()=>{
        searching = true; performSearch(kw);
      }, 400);
    });

    $('#clearSearch').addEventListener('click', ()=>{
      $('#searchInput').value = '';
      searching = false;
      loadUsers(0);
    });

    // ======= BOOT =======
    (async function init(){
      await loadKPIs();
      await loadUsers(0);
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
